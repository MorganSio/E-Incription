{% extends 'base.html.twig' %}

{% block title %}Ajout de fichier BTS{% endblock %}

{% block body %}
    {% for flash_error in app.flashes('verify_email_error') %}
        <div class="alert alert-danger" role="alert">{{ flash_error }}</div>
    {% endfor %}

    <main role="main" id="content">
        <form method="post" action="{{ path('fichier-upload') }}" enctype="multipart/form-data">
            <div class="fr-card fr-enlarge-link fr-card--download"> 
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <h3 class="fr-card__title">1 photo d'identité</h3>
                        <p class="fr-card__desc">Taille maximale : 100 Mo. Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.</p>
                        <div class="fr-card__end">
                            <p class="fr-card__detail">
                                    <input class="fr-upload" type="file" id="photo-upload" name="photo-upload[]">
                            </p>
                            <div id="photo-upload-error" class="fr-upload-group fr-upload-group--error" style="display: none;">
                                <p class="fr-error-text">Format de fichier non supporté</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-card fr-enlarge-link fr-card--download"> 
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <h3 class="fr-card__title">La notification de bourse</h3>
                        <p class="fr-card__desc">Taille maximale : 100 Mo. Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.</p>
                        <div class="fr-card__end">
                            <p class="fr-card__detail">
                                <input class="fr-upload" type="file" id="bourse-upload" name="bourse-upload[]">
                            </p>
                            <div id="bourse-upload-error" class="fr-upload-group fr-upload-group--error" style="display: none;">
                                <p class="fr-error-text">Format de fichier non supporté</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-card fr-enlarge-link fr-card--download"> 
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <h3 class="fr-card__title">L'assurance scolaire</h3>
                        <p class="fr-card__desc">Taille maximale : 100 Mo. Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.</p>
                        <div class="fr-card__end">
                            <p class="fr-card__detail">
                                <input class="fr-upload" type="file" id="assurance-upload" name="assurance-upload[]">
                            </p>
                            <div id="assurance-upload-error" class="fr-upload-group fr-upload-group--error" style="display: none;">
                                <p class="fr-error-text">Format de fichier non supporté</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-card fr-enlarge-link fr-card--download"> 
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <h3 class="fr-card__title">Certificat de la JDC</h3>
                        <p class="fr-card__desc">La photocopie du certificat de la participation à la journée défense et citoyenneté (JDC) obligatoire pour l’inscription aux épreuves de BTS pour les jeunes de nationalité française.</p>
                        <p class="fr-card__desc">Taille maximale : 100 Mo. Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.</p>
                        <div class="fr-card__end">
                            <p class="fr-card__detail">
                                <input class="fr-upload" type="file" id="JDC-upload" name="JDC-upload[]">
                            </p>
                            <div id="JDC-upload-error" class="fr-upload-group fr-upload-group--error" style="display: none;">
                                <p class="fr-error-text">Format de fichier non supporté</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-card fr-enlarge-link fr-card--download"> 
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <h3 class="fr-card__title">Attestation d'identité</h3>
                        <p class="fr-card__desc">une attestation de votre identité (copie recto-verso d’une pièce d’identité ou copie du livret de famille).</p>
                        <p class="fr-card__desc">Taille maximale : 100 Mo. Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.</p>
                        <div class="fr-card__end">
                            <p class="fr-card__detail">
                                <input class="fr-upload" type="file" multiple id="identite-upload" name="identite-upload[]">
                            </p>
                            <div id="identite-upload-error" class="fr-upload-group fr-upload-group--error" style="display: none;">
                                <p class="fr-error-text">Format de fichier non supporté</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-card fr-enlarge-link fr-card--download"> 
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <h3 class="fr-card__title">Attestation de réussite au baccalauréat</h3>
                        <p class="fr-card__desc">une attestation de votre réussite au baccalauréat (photocopie de votre relevé de notes).</p>
                        <p class="fr-card__desc">Taille maximale : 100 Mo. Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.</p>
                        <div class="fr-card__end">
                            <p class="fr-card__detail">
                                <input class="fr-upload" type="file" id="bac-upload" name="bac-upload[]">
                            </p>
                            <div id="bac-upload-error" class="fr-upload-group fr-upload-group--error" style="display: none;">
                                <p class="fr-error-text">Format de fichier non supporté</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-card fr-enlarge-link fr-card--download"> 
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <h3 class="fr-card__title">1 RIB DES PARENTS OBLIGATOIRE</h3>
                        <p class="fr-card__desc">Taille maximale : 100 Mo. Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.</p>
                        <div class="fr-card__end">
                            <p class="fr-card__detail">
                                <input class="fr-upload" type="file" id="rib-upload" name="rib-upload[]">
                            </p>
                            <div id="rib-upload-error" class="fr-upload-group fr-upload-group--error" style="display: none;">
                                <p class="fr-error-text">Format de fichier non supporté</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-card fr-enlarge-link fr-card--download"> 
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <div>
                            <h3 class="fr-card__title">Signature électronique</h3>
                            <p class="fr-card__desc">Veuillez signer ci-dessous :</p>
                        </div>
                        <div>
                            <div class="signature-container">
                                <canvas id="signature-pad"></canvas>
                            </div>
                            <div class="buttons">
                                <button type="button" id="clear-signature" class="fr-btn">Effacer</button>
                                <button type="button" id="save-signature" class="fr-btn">Valider</button>
                            </div>
                            <input type="hidden" name="signature" id="signature-input">
                        </div>
                    </div>
                </div>
            </div>
            <button class="fr-btn" type="submit">Envoyer</button>
        </form>
    </main>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
        const allowedFormats = ["image/jpeg", "image/png", "application/pdf"];
        function validateFile(inputId, errorId) {
            const input = document.getElementById(inputId);
            const errorDiv = document.getElementById(errorId);
            input.addEventListener("change", function () {
                let files = input.files;
                let isValid = true;

                for (let i = 0; i < files.length; i++) {
                    if (!allowedFormats.includes(files[i].type)) {
                        isValid = false;
                        break;
                    }
                }
                if (isValid) {
                    errorDiv.style.display = "none";
                } else {
                    errorDiv.style.display = "block";
                }
            });
        }
        validateFile("photo-upload", "photo-upload-error");
        validateFile("bourse-upload", "bourse-upload-error");
        validateFile("assurance-upload", "assurance-upload-error");
        validateFile("JDC-upload", "JDC-upload-error");
        validateFile("identite-upload", "identite-upload-error");
        validateFile("rib-upload", "rib-upload-error");
        validateFile("bac-upload", "bac-upload-error");

        const canvas = document.getElementById("signature-pad");
        const ctx = canvas.getContext("2d");
        const clearButton = document.getElementById("clear-signature");
        const saveButton = document.getElementById("save-signature");
        const signatureInput = document.getElementById("signature-input");
        function resizeCanvas() {
            const container = canvas.parentElement;
            const devicePixelRatio = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * devicePixelRatio;
            canvas.height = rect.height * devicePixelRatio;
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            ctx.strokeStyle = "#000";
        }
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureInput.value = "";
        }
        let drawing = false;
        let lastX, lastY;
        function getPosition(event) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }
        function startDrawing(e) {
            e.preventDefault();
            drawing = true;
            const pos = getPosition(e);
            lastX = pos.x;
            lastY = pos.y;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
        }
        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const pos = getPosition(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x;
            lastY = pos.y;
        }
        function stopDrawing() {
            if (drawing) {
                drawing = false;
                ctx.closePath();
                signatureInput.value = canvas.toDataURL("image/png");
            }
        }
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("touchstart", startDrawing);
        canvas.addEventListener("touchmove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("touchend", stopDrawing);
        canvas.addEventListener("mouseleave", stopDrawing);
        clearButton.addEventListener("click", clearCanvas);
        saveButton.addEventListener("click", function() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let isEmpty = true;
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 0) {
                    isEmpty = false;
                    break;
                }
            }
            if (isEmpty) {
                alert("Veuillez signer avant de valider.");
                return;
            }
            signatureInput.value = canvas.toDataURL("image/png");
            alert("Signature enregistrée");
        });
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        clearCanvas();
        });
    </script>
{% endblock %}